# CamS3 视频监控系统 PRD

**项目名称**: mycam - CamS3 智能视频监控系统
**版本**: v1.0
**日期**: 2025-01-02
**状态**: 设计阶段

---

## 1. 项目概述

### 1.1 项目背景

基于 M5Stack CamS3（ESP32-S3 芯片）构建的低成本智能视频监控系统。由于 ESP32 性能有限，需要采用轻量化的架构设计，同时提供完整的监控功能。

### 1.2 核心价值

- **低成本**: 基于开源硬件 + 无服务器架构，单设备月成本 < ¥10
- **智能检测**: 运动检测自动拍照，减少无效存储
- **多端通知**: 飞书/钉钉实时推送，第一时间知晓异常
- **灵活访问**: 局域网零延迟预览 + 互联网随时查看

### 1.3 目标用户

- 家庭用户：室内安全监控、宠物/老人看护
- 小型商户：店铺监控、异常报警
- 创客/DIY 爱好者：智能家居集成

---

## 2. 功能需求

### 2.1 核心功能

| 功能 | 优先级 | 描述 |
|------|--------|------|
| 实时视频预览 | P0 | 局域网内通过 Web 页面查看低延迟实时画面 |
| 运动检测拍照 | P0 | 画面变化时自动拍照并上传云端 |
| 历史照片查看 | P0 | Web 页面按时间轴查看历史照片 |
| 飞书通知 | P0 | 检测到运动时发送飞书消息卡片 |
| 钉钉通知 | P0 | 检测到运动时发送钉钉消息卡片 |
| 互联网远程访问 | P1 | 随时随地通过互联网查看历史照片 |
| 设备管理 | P1 | 多设备管理、配置检测灵敏度 |

### 2.2 详细功能说明

#### 2.2.1 实时视频预览（局域网）

**访问方式**
- 手机和摄像头在同一 WiFi 下
- 通过 mDNS 自动发现设备，或直接输入 IP 地址访问

**技术实现**
- CamS3 运行 HTTP Server，`/stream` 端点返回最新 JPEG 帧
- 前端定时轮询刷新 `<img>` 标签 src，实现 2-5 FPS 伪视频流
- 分辨率：QVGA (320x240)，保证流畅度

#### 2.2.2 运动检测拍照

**检测算法**
- 网格分区检测：将画面分为 8x8 或 16x16 网格
- 帧差算法：每个网格计算像素平均值，与上一帧对比
- 双重阈值：单网格变化阈值 + 触发网格数量阈值

**拍照策略**
- 检测到运动时拍照：VGA (640x480)，高质量 JPEG
- 持续运动：每 5 秒拍一张，避免重复存储
- 运动停止：连续 30 秒无运动后降低检测频率

#### 2.2.3 云端存储与通知

**存储方案**
- 原图：存储到阿里云 OSS，保留 30 天
- 缩略图：自动生成 300x300，保留 7 天
- 元数据：存储到 Tablestore（时间、设备、是否运动）

**通知推送**
- 飞书：自定义机器人 Webhook，发送卡片消息
- 钉钉：机器人 Webhook，发送 Markdown/卡片消息
- 用户可配置：启用/禁用飞书或钉钉通知

**消息卡片内容**
- 缩略图预览
- 检测时间
- 设备名称/位置
- "查看详情"按钮（跳转到 Web 前端）

#### 2.2.4 历史照片查看

**Web 前端功能**
- 时间轴展示：瀑布流或日历视图
- 筛选器：按日期、按"是否有运动"、按设备
- 图片操作：查看大图、下载、删除、分享
- 分页加载：滚动自动加载更多

#### 2.2.5 设备配置

**可配置项**
- 运动检测灵敏度（低/中/高）
- 抓图频率（1-5 FPS）
- 通知开关（飞书/钉钉）
- Webhook URL 配置

---

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Web 前端  │  飞书 App  │  钉钉 App  │  移动浏览器               │
└────────────────────┬────────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────────┐
│                         云端层（阿里云）                          │
├─────────────────────────────────────────────────────────────────┤
│  OSS（存储）  │  函数计算（处理）  │  API 网关  │  Tablestore     │
│  ┌─────────┐  │  ┌────────────┐   │  ┌──────┐  │  ┌──────────┐  │
│  │ 原图/   │  │  │ upload/    │   │  │ API  │  │  │ images/  │  │
│  │ 缩略图  │  │  │ notify/    │   │  │ 路由 │  │  │ devices  │  │
│  └─────────┘  │  └────────────┘   │  └──────┘  │  └──────────┘  │
│               │                   │            │                │
│  ┌─────────┐  │  ┌────────────┐   │            │  ┌──────────┐  │
│  │ 前端资源 │  │  │ RAM        │   │            │  │ RAM      │  │
│  └─────────┘  │  │ STS Token  │   │            │  │ 访问控制 │  │
│               │  └────────────┘   │            │  └──────────┘  │
└────────────────────┬────────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────────┐
│                        通知集成层                                 │
├─────────────────────────────────────────────────────────────────┤
│  飞书开放平台（Webhook）  │  钉钉开放平台（Webhook）              │
└─────────────────────────────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────────┐
│                         设备层                                    │
├─────────────────────────────────────────────────────────────────┤
│  M5Stack CamS3（ESP32-S3）                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 图像采集  │  运动检测  │  HTTP Server  │  WiFi/网络      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 CamS3 固件架构

**技术栈**
- PlatformIO + ESP32-Arduino 框架
- ESPWiFi / ESPmDNS / AsyncWebServer_ESP32
- ESP32 Camera 库（OV2640 支持）
- ArduinoJson

**核心模块**
1. 图像采集模块：定时抓图、双缓冲、分辨率设置
2. 运动检测模块：网格分区、帧差算法、阈值配置
3. 通信模块：HTTP Server（局域网）、HTTP Client（云端）
4. 配置管理：WiFi 配置、设备注册、OTA 升级

**性能优化**
- FreeRTOS 多任务：采集、检测、网络分离
- JPEG 质量动态调整
- 运动检测降采样

### 3.3 云端架构

**OSS 存储结构**
```
bucket-name/
├── devices/{device_id}/
│   ├── original/     # 原图
│   └── thumbnail/    # 缩略图
├── frontend/         # Web 前端
└── configs/          # 配置快照
```

**函数计算**
1. `upload-handler`: 处理图片上传元数据
2. `notify-sender`: 发送飞书/钉钉通知
3. `image-query`: 查询历史图片列表
4. `device-manager`: 设备管理、STS Token

**API 网关路由**
```
POST /api/v1/images/upload     → upload-handler
GET  /api/v1/images/list       → image-query
POST /api/v1/device/register   → device-manager
POST /api/v1/device/config     → device-manager
GET  /api/v1/device/token      → device-manager (STS Token)
```

### 3.4 前端架构

**技术栈**
- Vue 3 + Vite
- Element Plus / Naive UI
- Pinia + Vue Router + Axios
- 部署到阿里云 OSS + CDN

**核心页面**
1. 设备列表页：显示所有设备、在线状态
2. 实时预览页：局域网视频流
3. 历史照片页：时间轴展示、筛选、操作
4. 设置页：通知配置、设备管理

---

## 4. 数据流设计

### 4.1 局域网实时视频流

```
手机浏览器 ──mDNS发现──→ CamS3 IP
                     │
     HTTP GET /stream ──────→ 获取最新 JPEG 帧
                     │
                     ←───── 返回 image/jpeg
                     │
前端定时刷新 src 实现 2-5 FPS 伪视频流
```

### 4.2 运动检测 + 云端通知

```
CamS3 固件                    阿里云                    飞书/钉钉
    │                            │                         │
    ├─ 定时抓图                   │                         │
    ├─ 网格分区运动检测           │                         │
    │   └─ 检测到变化            │                         │
    │                            │                         │
    ├─ 获取 STS Token ─────────→ device-manager           │
    │  ←─────────────────────── 返回 Token                │
    │                            │                         │
    ├─ 上传原图到 OSS             │                         │
    ├─ 上传缩略图到 OSS           │                         │
    │                            │                         │
    ├─ 上报元数据 ─────────────→ upload-handler           │
    │  ←─────────────────────── 返回 200 OK               │
    │                            │                         │
    │                            ├─ 触发 notify-sender     │
    │                            │                         │
    │                            ├─ 查询通知配置           │
    │                            │                         │
    │                            ├─ 发送飞书消息 ─────────→ 飞书
    │                            ├─ 发送钉钉消息 ─────────→ 钉钉
    │                            │                         │
用户收到通知 ───────────────────────────────────────────────
```

### 4.3 查看历史照片

```
Web 前端
    │
    ├─ GET /api/v1/images/list?device_id=xxx&start=xxx&end=xxx
    │
image-query 函数
    │
    ├─ 查询 Tablestore
    ├─ 生成 OSS 签名 URL（有效期 1 小时）
    │
    │  ←──────────── 返回图片列表 + 签名 URL
    │
前端渲染时间轴
```

---

## 5. 错误处理与容错

### 5.1 设备端容错

| 场景 | 处理策略 |
|------|----------|
| WiFi 断连 | 自动重连，指数退避（1s → 30s） |
| 上传失败 | 暂存到 SD 卡，最多 50 张，恢复后补传 |
| 云函数超时 | 3 次重试，失败后本地日志记录 |
| 内存不足 | 降低 JPEG 质量，减少缓存帧数 |
| CPU 过载 | 降低检测频率，跳帧处理 |

### 5.2 云端容错

| 场景 | 处理策略 |
|------|----------|
| 函数执行失败 | 自动重试 3 次 |
| OSS 上传失败 | 分片上传，断点续传 |
| 通知发送失败 | 不影响主流程，记录日志定期重试 |
| 消息轰炸 | 同一设备 1 分钟最多 5 次通知 |

### 5.3 安全机制

- **STS Token**: 15 分钟有效期，限制路径前缀
- **HTTPS**: 所有 API 通信强制 HTTPS
- **签名验证**: Webhook URL 加密存储
- **版本控制**: OSS 开启版本管理，防止误删

---

## 6. 技术选型

### 6.1 硬件

| 组件 | 型号 | 说明 |
|------|------|------|
| 摄像头 | M5Stack CamS3 | ESP32-S3 + OV2640 |
| 存储 | 内置 PSRAM + TF 卡槽 | 图片缓存 |

### 6.2 云服务

| 服务 | 选用 | 说明 |
|------|------|------|
| 存储 | 阿里云 OSS | 图片、前端托管 |
| 计算 | 阿里云函数计算 | 无服务器架构 |
| 数据库 | 阿里云 Tablestore | 元数据存储 |
| 网关 | 阿里云 API 网关 | API 路由、鉴权 |
| 加速 | 阿里云 CDN | 前端资源加速 |

### 6.3 开发框架

| 层级 | 框架 | 说明 |
|------|------|------|
| 固件 | PlatformIO + ESP32-Arduino | 轻量、社区活跃 |
| 前端 | Vue 3 + Vite | 快速开发、生态丰富 |
| 后端 | 阿里云 FC + Node.js | 无服务器、按需付费 |
| IaC | Terraform | 基础设施即代码 |

---

## 7. 成本估算

### 7.1 月度成本（单设备）

| 资源 | 规格 | 用量 | 月成本 |
|------|------|------|--------|
| OSS 存储 | 0.12元/GB/月 | 2GB | ¥0.24 |
| OSS 流量 | 0.5元/GB | 20GB | ¥10 |
| 函数计算 | 0.0000167元/VCU/秒 | 10万VCU秒 | ¥1.67 |
| API 网关 | 0.005元/千次调用 | 30万次 | ¥1.5 |
| Tablestore | 0.000117元/RCU/秒 | 4CU | ¥0.4 |
| CDN 流量 | 0.24元/GB | 10GB | ¥2.4 |
| **总计** | - | - | **¥16.21/月** |

*注：多设备可摊薄固定成本，单设备成本约 ¥5-10/月*

---

## 8. 开发计划

### 8.1 里程碑

| 阶段 | 内容 | 交付物 |
|------|------|--------|
| M1: 固件基础 | CamS3 图像采集、HTTP Server、运动检测 | 固件 v0.1 |
| M2: 云端基础 | OSS 上传、函数计算、Tablestore | 云端 v0.1 |
| M3: 通知集成 | 飞书/钉钉 Webhook、消息卡片 | 通知 v0.1 |
| M4: 前端基础 | 设备列表、实时预览、历史照片 | 前端 v0.1 |
| M5: 完善优化 | 错误处理、性能优化、测试 | v1.0 正式版 |

### 8.2 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| ESP32 性能不足 | 视频卡顿、检测延迟 | 降低分辨率、优化算法 |
| OSS 上传延迟 | 通知滞后 | 异步处理、超时重试 |
| 飞书/钉钉 API 变更 | 通知失效 | 版本锁定、监控告警 |

---

## 9. 非功能需求

### 9.1 性能要求

- 实时预览延迟: < 500ms（局域网）
- 运动检测响应: < 3 秒
- 通知推送延迟: < 10 秒
- 图片加载时间: < 2 秒（缩略图）

### 9.2 可靠性要求

- 设备在线率: > 99%（含 WiFi 不稳定因素）
- 图片上传成功率: > 99.9%
- 通知送达率: > 95%（依赖第三方平台）

### 9.3 安全要求

- 所有 API 通信使用 HTTPS
- STS Token 限制访问范围和有效期
- 用户数据加密存储
- Webhook URL 验证签名

---

## 10. 附录

### 10.1 参考文档

- [M5Stack CamS3 文档](https://docs.m5stack.com/en/unit/cams3)
- [阿里云函数计算文档](https://help.aliyun.com/product/50980.html)
- [阿里云 OSS 文档](https://help.aliyun.com/product/31815.html)
- [飞书开放平台](https://open.feishu.cn/)
- [钉钉开放平台](https://open.dingtalk.com/)

### 10.2 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-01-02 | 初始版本 | Claude |

# M4: 前端基础实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标:** 实现 Web 前端基础功能，包括设备列表页、实时预览页（局域网）、历史照片页和设置页。支持手机和桌面浏览器响应式布局。

**架构:** Vue 3 + Vite 单页应用，使用 Pinia 管理状态。前端部署到阿里云 OSS + CDN，通过 API 网关与云端通信。局域网环境直接访问 CamS3 IP。

**技术栈:** Vue 3, Vite, Element Plus, Pinia, Vue Router, Axios

---

## Task 1: 项目初始化

**Files:**
- Create: `frontend/package.json`
- Create: `frontend/vite.config.js`
- Create: `frontend/index.html`
- Create: `frontend/src/main.js`
- Create: `frontend/src/App.vue`
- Create: `frontend/.gitignore`

**Step 1: 创建 package.json**

```json
{
  "name": "mycam-frontend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js"
  },
  "dependencies": {
    "vue": "^3.4.0",
    "vue-router": "^4.2.5",
    "pinia": "^2.1.7",
    "axios": "^1.6.2",
    "element-plus": "^2.4.4",
    "@element-plus/icons-vue": "^2.3.1"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.0.0",
    "vite": "^5.0.8",
    "sass": "^1.69.5"
  }
}
```

**Step 2: 创建 vite.config.js**

```javascript
// frontend/vite.config.js
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';
import { resolve } from 'path';

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'https://your-api-gateway.com',
        changeOrigin: true
      }
    }
  },
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          'element-plus': ['element-plus']
        }
      }
    }
  }
});
```

**Step 3: 创建 index.html**

```html
<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyCam 监控系统</title>
</head>
<body>
  <div id="app"></div>
  <script type="module" src="/src/main.js"></script>
</body>
</html>
```

**Step 4: 创建 main.js**

```javascript
// frontend/src/main.js
import { createApp } from 'vue';
import { createPinia } from 'pinia';
import ElementPlus from 'element-plus';
import 'element-plus/dist/index.css';
import * as ElementPlusIconsVue from '@element-plus/icons-vue';

import App from './App.vue';
import router from './router';

const app = createApp(App);

// 注册所有图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component);
}

app.use(createPinia());
app.use(router);
app.use(ElementPlus);

app.mount('#app');
```

**Step 5: 创建 App.vue**

```vue
<!-- frontend/src/App.vue -->
<template>
  <el-config-provider :locale="zhCn">
    <router-view />
  </el-config-provider>
</template>

<script setup>
import zhCn from 'element-plus/dist/locale/zh-cn.mjs';
</script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: #f5f7fa;
}

#app {
  min-height: 100vh;
}
</style>
```

**Step 6: 创建 .gitignore**

```
node_modules/
dist/
.DS_Store
*.log
```

**Step 7: 安装依赖**

```bash
cd frontend
npm install
```

**Step 8: 提交**

```bash
git add frontend/
git commit -m "feat(m4): initialize Vue 3 + Vite project"
```

---

## Task 2: 路由和状态管理

**Files:**
- Create: `frontend/src/router/index.js`
- Create: `frontend/src/stores/devices.js`
- Create: `frontend/src/stores/settings.js`
- Create: `frontend/src/api/index.js`

**Step 1: 创建路由配置**

```javascript
// frontend/src/router/index.js
import { createRouter, createWebHistory } from 'vue-router';

const routes = [
  {
    path: '/',
    redirect: '/devices'
  },
  {
    path: '/devices',
    name: 'DeviceList',
    component: () => import('@/views/DeviceList.vue'),
    meta: { title: '设备列表' }
  },
  {
    path: '/preview/:id',
    name: 'Preview',
    component: () => import('@/views/Preview.vue'),
    meta: { title: '实时预览' }
  },
  {
    path: '/images',
    name: 'ImageList',
    component: () => import('@/views/ImageList.vue'),
    meta: { title: '历史照片' }
  },
  {
    path: '/settings',
    name: 'Settings',
    component: () => import('@/views/Settings.vue'),
    meta: { title: '设置' }
  }
];

const router = createRouter({
  history: createWebHistory(),
  routes
});

router.beforeEach((to, from, next) => {
  document.title = to.meta.title ? `${to.meta.title} - MyCam` : 'MyCam';
  next();
});

export default router;
```

**Step 2: 创建设备状态管理**

```javascript
// frontend/src/stores/devices.js
import { defineStore } from 'pinia';
import { ref } from 'vue';

export const useDevicesStore = defineStore('devices', () => {
  const devices = ref([]);

  function addDevice(device) {
    const index = devices.value.findIndex(d => d.id === device.id);
    if (index >= 0) {
      devices.value[index] = device;
    } else {
      devices.value.push(device);
    }
  }

  function removeDevice(id) {
    const index = devices.value.findIndex(d => d.id === id);
    if (index >= 0) {
      devices.value.splice(index, 1);
    }
  }

  function updateDevice(id, updates) {
    const device = devices.value.find(d => d.id === id);
    if (device) {
      Object.assign(device, updates);
    }
  }

  function getDevice(id) {
    return devices.value.find(d => d.id === id);
  }

  return {
    devices,
    addDevice,
    removeDevice,
    updateDevice,
    getDevice
  };
});
```

**Step 3: 创建设置状态管理**

```javascript
// frontend/src/stores/settings.js
import { defineStore } from 'pinia';
import { ref } from 'vue';

export const useSettingsStore = defineStore('settings', () => {
  const apiBaseUrl = ref(localStorage.getItem('apiBaseUrl') || '');
  const isLocalNetwork = ref(false);

  function setApiBaseUrl(url) {
    apiBaseUrl.value = url;
    localStorage.setItem('apiBaseUrl', url);
  }

  function setIsLocalNetwork(value) {
    isLocalNetwork.value = value;
  }

  return {
    apiBaseUrl,
    isLocalNetwork,
    setApiBaseUrl,
    setIsLocalNetwork
  };
});
```

**Step 4: 创建 API 客户端**

```javascript
// frontend/src/api/index.js
import axios from 'axios';
import { useSettingsStore } from '@/stores/settings';

const apiClient = axios.create({
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// 请求拦截器
apiClient.interceptors.request.use(
  (config) => {
    const settings = useSettingsStore();
    if (settings.apiBaseUrl) {
      config.baseURL = settings.apiBaseUrl;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    console.error('API Error:', error);
    return Promise.reject(error);
  }
);

// API 方法
export const api = {
  // 获取设备列表
  getDevices: () => apiClient.get('/api/v1/devices'),

  // 获取图片列表
  getImages: (params) => apiClient.get('/api/v1/images/list', { params }),

  // 获取 STS Token
  getSTSToken: (deviceId) => apiClient.post('/api/v1/device/token', { device_id: deviceId }),

  // 上报图片元数据
  uploadImageMeta: (data) => apiClient.post('/api/v1/images/upload', data),

  // 获取设备配置
  getDeviceConfig: (deviceId) => apiClient.get('/api/v1/device/config', { params: { device_id: deviceId } }),

  // 更新设备配置
  updateDeviceConfig: (data) => apiClient.post('/api/v1/device/config', data),

  // 验证 Webhook
  verifyWebhook: (platform, webhook) => apiClient.post('/api/v1/device/verify-webhook', { platform, webhook })
};

export default apiClient;
```

**Step 5: 提交**

```bash
git add frontend/src/
git commit -m "feat(m4): add router, stores and API client"
```

---

## Task 3: 设备列表页

**Files:**
- Create: `frontend/src/views/DeviceList.vue`

**Step 1: 创建设备列表组件**

```vue
<!-- frontend/src/views/DeviceList.vue -->
<template>
  <div class="device-list">
    <el-container>
      <el-header>
        <h1>MyCam 监控系统</h1>
        <el-button type="primary" @click="showAddDialog = true">
          <el-icon><Plus /></el-icon>
          添加设备
        </el-button>
      </el-header>

      <el-main>
        <el-row :gutter="20" v-if="devices.length > 0">
          <el-col v-for="device in devices" :key="device.id" :xs="24" :sm="12" :md="8" :lg="6">
            <el-card class="device-card" shadow="hover">
              <template #header>
                <div class="card-header">
                  <span>{{ device.name }}</span>
                  <el-tag :type="device.online ? 'success' : 'danger'" size="small">
                    {{ device.online ? '在线' : '离线' }}
                  </el-tag>
                </div>
              </template>

              <div class="device-info">
                <p><el-icon><Location /></el-icon> {{ device.location || '未设置位置' }}</p>
                <p><el-icon><Clock /></el-icon> 最后在线: {{ formatTime(device.lastOnline) }}</p>
              </div>

              <div class="device-actions">
                <el-button type="primary" size="small" @click="goToPreview(device)">
                  <el-icon><VideoCamera /></el-icon>
                  预览
                </el-button>
                <el-button size="small" @click="goToImages(device)">
                  <el-icon><Picture /></el-icon>
                  照片
                </el-button>
                <el-button size="small" @click="editDevice(device)">
                  <el-icon><Setting /></el-icon>
                </el-button>
              </div>
            </el-card>
          </el-col>
        </el-row>

        <el-empty v-else description="暂无设备，请添加设备" />

        <!-- 添加设备对话框 -->
        <el-dialog v-model="showAddDialog" title="添加设备" width="90%" :style="{ maxWidth: '500px' }">
          <el-form :model="newDevice" label-width="80px">
            <el-form-item label="设备 ID">
              <el-input v-model="newDevice.id" placeholder="输入设备 ID" />
            </el-form-item>
            <el-form-item label="设备名称">
              <el-input v-model="newDevice.name" placeholder="输入设备名称" />
            </el-form-item>
            <el-form-item label="设备位置">
              <el-input v-model="newDevice.location" placeholder="输入设备位置" />
            </el-form-item>
          </el-form>
          <template #footer>
            <el-button @click="showAddDialog = false">取消</el-button>
            <el-button type="primary" @click="handleAddDevice">确定</el-button>
          </template>
        </el-dialog>
      </el-main>
    </el-container>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { useRouter } from 'vue-router';
import { useDevicesStore } from '@/stores/devices';
import { ElMessage } from 'element-plus';

const router = useRouter();
const devicesStore = useDevicesStore();
const { devices } = devicesStore;

const showAddDialog = ref(false);
const newDevice = ref({
  id: '',
  name: '',
  location: ''
});

function formatTime(timestamp) {
  if (!timestamp) return '未知';
  const date = new Date(timestamp);
  return date.toLocaleString('zh-CN');
}

function goToPreview(device) {
  router.push(`/preview/${device.id}`);
}

function goToImages(device) {
  router.push(`/images?device=${device.id}`);
}

function editDevice(device) {
  router.push(`/settings?device=${device.id}`);
}

function handleAddDevice() {
  if (!newDevice.value.id || !newDevice.value.name) {
    ElMessage.warning('请填写设备 ID 和名称');
    return;
  }

  devicesStore.addDevice({
    ...newDevice.value,
    online: false,
    lastOnline: null
  });

  showAddDialog.value = false;
  newDevice.value = { id: '', name: '', location: '' };

  ElMessage.success('设备添加成功');
}
</script>

<style scoped>
.device-list {
  min-height: 100vh;
}

.el-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 0 20px;
}

.el-header h1 {
  font-size: 1.5rem;
  margin: 0;
}

.el-main {
  padding: 20px;
}

.device-card {
  margin-bottom: 20px;
  transition: transform 0.2s;
}

.device-card:hover {
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.device-info p {
  margin: 8px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  color: #666;
}

.device-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.device-actions .el-button {
  flex: 1;
}
</style>
```

**Step 2: 提交**

```bash
git add frontend/src/views/
git commit -m "feat(m4): implement device list page"
```

---

## Task 4: 实时预览页

**Files:**
- Create: `frontend/src/views/Preview.vue`

**Step 1: 创建预览组件**

```vue
<!-- frontend/src/views/Preview.vue -->
<template>
  <div class="preview">
    <el-page-header @back="goBack" :content="deviceName">
      <template #extra>
        <el-tag :type="isConnected ? 'success' : 'danger'">
          {{ isConnected ? '已连接' : '未连接' }}
        </el-tag>
      </template>
    </el-page-header>

    <div class="video-container">
      <img
        ref="videoRef"
        :src="streamUrl"
        @load="onImageLoad"
        @error="onImageError"
        alt="视频流"
      />

      <div class="video-overlay" v-if="!isConnected">
        <el-icon><Loading /></el-icon>
        <p>正在连接摄像头...</p>
      </div>
    </div>

    <div class="controls">
      <el-button-group>
        <el-button @click="capture" :disabled="!isConnected">
          <el-icon><Camera /></el-icon>
          抓拍
        </el-button>
        <el-button @click="toggleStream">
          <el-icon><VideoPause v-if="isPlaying" /><VideoPlay v-else /></el-icon>
          {{ isPlaying ? '暂停' : '继续' }}
        </el-button>
      </el-button-group>

      <el-select v-model="fps" @change="updateFps" style="width: 120px; margin-left: 12px;">
        <el-option label="1 FPS" :value="1" />
        <el-option label="2 FPS" :value="2" />
        <el-option label="3 FPS" :value="3" />
        <el-option label="5 FPS" :value="5" />
      </el-select>
    </div>

    <el-divider />

    <div class="status">
      <el-descriptions :column="2" border>
        <el-descriptions-item label="分辨率">{{ imageSize }}</el-descriptions-item>
        <el-descriptions-item label="帧率">{{ fps }} FPS</el-descriptions-item>
        <el-descriptions-item label="最后更新">{{ lastUpdate }}</el-descriptions-item>
        <el-descriptions-item label="运动检测">
          <el-tag :type="hasMotion ? 'danger' : 'info'" size="small">
            {{ hasMotion ? '检测到运动' : '无' }}
          </el-tag>
        </el-descriptions-item>
      </el-descriptions>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useDevicesStore } from '@/stores/devices';
import { ElMessage } from 'element-plus';

const route = useRoute();
const router = useRouter();
const devicesStore = useDevicesStore();

const deviceId = route.params.id;
const device = computed(() => devicesStore.getDevice(deviceId));
const deviceName = computed(() => device.value?.name || deviceId);

const videoRef = ref(null);
const isConnected = ref(false);
const isPlaying = ref(true);
const hasMotion = ref(false);
const fps = ref(3);
const imageSize = ref('-');
const lastUpdate = ref('-');

let streamTimer = null;
let motionTimer = null;

const streamUrl = computed(() => {
  // 局域网模式：直接访问设备 IP
  // 互联网模式：显示占位符
  return `http://${device.value?.ip || 'localhost'}/stream`;
});

function goBack() {
  router.back();
}

function onImageLoad() {
  isConnected.value = true;
  const img = videoRef.value;
  if (img) {
    imageSize.value = `${img.naturalWidth}x${img.naturalHeight}`;
    lastUpdate.value = new Date().toLocaleTimeString();
  }
}

function onImageError() {
  isConnected.value = false;
}

function updateStream() {
  if (isPlaying.value && videoRef.value) {
    videoRef.value.src = `${streamUrl.value}?t=${Date.now()}`;
  }
}

function updateFps() {
  stopStream();
  startStream();
  ElMessage.success(`帧率已设置为 ${fps.value} FPS`);
}

function startStream() {
  const interval = 1000 / fps.value;
  streamTimer = setInterval(updateStream, interval);
}

function stopStream() {
  if (streamTimer) {
    clearInterval(streamTimer);
    streamTimer = null;
  }
}

function toggleStream() {
  isPlaying.value = !isPlaying.value;
  if (isPlaying.value) {
    startStream();
  } else {
    stopStream();
  }
}

async function checkMotion() {
  try {
    const response = await fetch(`http://${device.value?.ip || 'localhost'}/motion`);
    const data = await response.json();
    hasMotion.value = data.motion || false;
  } catch (error) {
    // 忽略错误
  }
}

function capture() {
  ElMessage.success('已抓拍当前画面');
  // TODO: 实现抓拍功能
}

onMounted(() => {
  startStream();
  motionTimer = setInterval(checkMotion, 500);
});

onUnmounted(() => {
  stopStream();
  if (motionTimer) {
    clearInterval(motionTimer);
  }
});
</script>

<style scoped>
.preview {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.video-container {
  position: relative;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  aspect-ratio: 4/3;
}

.video-container img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.video-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #fff;
  background: rgba(0, 0, 0, 0.5);
}

.video-overlay .el-icon {
  font-size: 48px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.controls {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
}

.status {
  margin-top: 20px;
}
</style>
```

**Step 2: 提交**

```bash
git add frontend/src/views/
git commit -m "feat(m4): implement live preview page"
```

---

## Task 5: 历史照片页

**Files:**
- Create: `frontend/src/views/ImageList.vue`
- Create: `frontend/src/components/ImageCard.vue`

**Step 1: 创建图片卡片组件**

```vue
<!-- frontend/src/components/ImageCard.vue -->
<template>
  <div class="image-card" @click="$emit('click', image)">
    <div class="image-wrapper">
      <img :src="thumbnailUrl" :alt="formatTime(image.created_at)" loading="lazy" />
      <el-tag v-if="image.has_motion" type="danger" size="small" class="motion-tag">
        运动
      </el-tag>
    </div>
    <div class="image-info">
      <span class="time">{{ formatTime(image.created_at) }}</span>
      <span class="size">{{ formatSize(image.image_size) }}</span>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue';

const props = defineProps({
  image: {
    type: Object,
    required: true
  }
});

defineEmits(['click']);

const thumbnailUrl = computed(() => {
  // 使用 OSS 签名 URL
  return props.image.oss_path_thumbnail || props.image.oss_path_original;
});

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return '刚刚';
  if (diff < 3600000) return `${Math.floor(diff / 60000)} 分钟前`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)} 小时前`;

  return date.toLocaleDateString('zh-CN');
}

function formatSize(bytes) {
  if (!bytes) return '-';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1024 / 1024).toFixed(1) + ' MB';
}
</script>

<style scoped>
.image-card {
  cursor: pointer;
  transition: transform 0.2s;
}

.image-card:hover {
  transform: scale(1.02);
}

.image-wrapper {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  aspect-ratio: 4/3;
  background: #f0f0f0;
}

.image-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.motion-tag {
  position: absolute;
  top: 8px;
  right: 8px;
}

.image-info {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 12px;
  color: #666;
}
</style>
```

**Step 2: 创建图片列表页面**

```vue
<!-- frontend/src/views/ImageList.vue -->
<template>
  <div class="image-list">
    <el-page-header @back="goBack" content="历史照片" />

    <div class="filters">
      <el-select v-model="selectedDevice" placeholder="选择设备" @change="loadImages">
        <el-option label="全部设备" :value="null" />
        <el-option
          v-for="device in devices"
          :key="device.id"
          :label="device.name"
          :value="device.id"
        />
      </el-select>

      <el-select v-model="motionOnly" @change="loadImages">
        <el-option label="全部照片" :value="false" />
        <el-option label="仅运动照片" :value="true" />
      </el-select>

      <el-date-picker
        v-model="dateRange"
        type="daterange"
        range-separator="至"
        start-placeholder="开始日期"
        end-placeholder="结束日期"
        @change="loadImages"
      />
    </div>

    <el-divider />

    <div v-loading="loading" class="images-grid">
      <ImageCard
        v-for="image in images"
        :key="image.row_key"
        :image="image"
        @click="viewImage"
      />
    </div>

    <el-empty v-if="!loading && images.length === 0" description="暂无照片" />

    <div class="pagination" v-if="hasMore">
      <el-button @click="loadMore" :loading="loadingMore">
        加载更多
      </el-button>
    </div>

    <!-- 图片预览对话框 -->
    <el-dialog v-model="showPreview" :width="'90%'" :style="{ maxWidth: '800px' }">
      <div class="preview-dialog">
        <img :src="previewUrl" alt="预览" />
        <div class="preview-actions">
          <el-button @click="downloadImage">
            <el-icon><Download /></el-icon>
            下载
          </el-button>
          <el-button @click="deleteImage" type="danger">
            <el-icon><Delete /></el-icon>
            删除
          </el-button>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useDevicesStore } from '@/stores/devices';
import { api } from '@/api';
import ImageCard from '@/components/ImageCard.vue';
import { ElMessage, ElMessageBox } from 'element-plus';

const route = useRoute();
const router = useRouter();
const devicesStore = useDevicesStore();
const { devices } = devicesStore;

const loading = ref(false);
const loadingMore = ref(false);
const images = ref([]);
const hasMore = ref(false);
const selectedDevice = ref(route.query.device || null);
const motionOnly = ref(false);
const dateRange = ref(null);
const showPreview = ref(false);
const currentImage = ref(null);

const previewUrl = computed(() => {
  return currentImage.value?.oss_path_original || '';
});

function goBack() {
  router.back();
}

async function loadImages() {
  loading.value = true;
  try {
    const params = {
      device_id: selectedDevice.value,
      has_motion: motionOnly.value ? true : undefined,
      limit: 50
    };

    if (dateRange.value) {
      params.start_time = dateRange.value[0].getTime();
      params.end_time = dateRange.value[1].getTime();
    }

    const result = await api.getImages(params);
    images.value = result.images || [];
    hasMore.value = !!result.next_token;
  } catch (error) {
    ElMessage.error('加载图片失败');
  } finally {
    loading.value = false;
  }
}

async function loadMore() {
  loadingMore.value = true;
  try {
    // TODO: 实现分页加载
    await loadImages();
  } finally {
    loadingMore.value = false;
  }
}

function viewImage(image) {
  currentImage.value = image;
  showPreview.value = true;
}

function downloadImage() {
  const link = document.createElement('a');
  link.href = previewUrl.value;
  link.download = `mycam-${currentImage.value.row_key}.jpg`;
  link.click();
}

async function deleteImage() {
  try {
    await ElMessageBox.confirm('确定删除这张照片吗？', '提示', {
      type: 'warning'
    });

    // TODO: 调用删除 API
    ElMessage.success('删除成功');
    showPreview.value = false;
    loadImages();
  } catch {
    // 用户取消
  }
}

onMounted(() => {
  loadImages();
});
</script>

<style scoped>
.image-list {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 20px;
}

.images-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 20px;
}

.pagination {
  text-align: center;
  margin-top: 30px;
}

.preview-dialog {
  text-align: center;
}

.preview-dialog img {
  max-width: 100%;
  max-height: 70vh;
  border-radius: 8px;
}

.preview-actions {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
}
</style>
```

**Step 3: 提交**

```bash
git add frontend/src/
git commit -m "feat(m4): implement image list page with preview"
```

---

## Task 6: 设置页面

**Files:**
- Create: `frontend/src/views/Settings.vue`

**Step 1: 创建设置页面**

```vue
<!-- frontend/src/views/Settings.vue -->
<template>
  <div class="settings">
    <el-page-header @back="goBack" content="设置" />

    <el-tabs v-model="activeTab" class="settings-tabs">
      <el-tab-pane label="通知设置" name="notification">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>飞书通知</span>
              <el-switch v-model="config.notify_feishu" @change="saveConfig" />
            </div>
          </template>

          <el-form label-width="100px" v-if="config.notify_feishu">
            <el-form-item label="Webhook URL">
              <el-input
                v-model="config.feishu_webhook"
                placeholder="输入飞书机器人 Webhook URL"
                show-password
              />
            </el-form-item>
            <el-form-item>
              <el-button @click="testWebhook('feishu')">测试发送</el-button>
            </el-form-item>
          </el-form>
        </el-card>

        <el-card style="margin-top: 16px;">
          <template #header>
            <div class="card-header">
              <span>钉钉通知</span>
              <el-switch v-model="config.notify_dingtalk" @change="saveConfig" />
            </div>
          </template>

          <el-form label-width="100px" v-if="config.notify_dingtalk">
            <el-form-item label="Webhook URL">
              <el-input
                v-model="config.dingtalk_webhook"
                placeholder="输入钉钉机器人 Webhook URL"
                show-password
              />
            </el-form-item>
            <el-form-item>
              <el-button @click="testWebhook('dingtalk')">测试发送</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </el-tab-pane>

      <el-tab-pane label="设备配置" name="device">
        <el-card>
          <el-form label-width="120px">
            <el-form-item label="检测灵敏度">
              <el-select v-model="deviceConfig.sensitivity" @change="saveDeviceConfig">
                <el-option label="低" value="low" />
                <el-option label="中" value="medium" />
                <el-option label="高" value="high" />
              </el-select>
            </el-form-item>
            <el-form-item label="抓图频率">
              <el-slider v-model="deviceConfig.fps" :min="1" :max="5" @change="saveDeviceConfig" />
            </el-form-item>
          </el-form>
        </el-card>
      </el-tab-pane>

      <el-tab-pane label="关于" name="about">
        <el-card>
          <h3>MyCam 监控系统</h3>
          <p>版本: 1.0.0</p>
          <p>基于 M5Stack CamS3 的智能视频监控解决方案</p>
        </el-card>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { api } from '@/api';
import { ElMessage } from 'element-plus';

const route = useRoute();
const router = useRouter();

const activeTab = ref('notification');
const deviceId = route.query.device;

const config = ref({
  notify_feishu: false,
  notify_dingtalk: false,
  feishu_webhook: '',
  dingtalk_webhook: ''
});

const deviceConfig = ref({
  sensitivity: 'medium',
  fps: 3
});

function goBack() {
  router.back();
}

async function loadConfig() {
  if (!deviceId) return;

  try {
    const result = await api.getDeviceConfig(deviceId);
    Object.assign(config.value, result);
  } catch (error) {
    console.error('Failed to load config:', error);
  }
}

async function saveConfig() {
  if (!deviceId) return;

  try {
    await api.updateDeviceConfig({
      device_id: deviceId,
      ...config.value
    });
    ElMessage.success('设置已保存');
  } catch (error) {
    ElMessage.error('保存失败');
  }
}

async function saveDeviceConfig() {
  // TODO: 发送设备配置更新
  ElMessage.success('设备配置已更新');
}

async function testWebhook(platform) {
  const webhook = platform === 'feishu'
    ? config.value.feishu_webhook
    : config.value.dingtalk_webhook;

  if (!webhook) {
    ElMessage.warning('请先输入 Webhook URL');
    return;
  }

  try {
    await api.verifyWebhook(platform, webhook);
    ElMessage.success('测试消息已发送，请检查您的飞书/钉钉');
  } catch (error) {
    ElMessage.error('测试失败: ' + error.message);
  }
}

onMounted(() => {
  loadConfig();
});
</script>

<style scoped>
.settings {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
}

.settings-tabs {
  margin-top: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
</style>
```

**Step 2: 提交**

```bash
git add frontend/src/views/
git commit -m "feat(m4): implement settings page"
```

---

## Task 7: 构建和部署

**Files:**
- Create: `frontend/deploy.sh`

**Step 1: 创建部署脚本**

```bash
#!/bin/bash
# frontend/deploy.sh

echo "Building frontend..."

# 安装依赖
npm install

# 构建
npm run build

# 上传到 OSS
echo "Uploading to OSS..."

BUCKET_NAME="your-bucket-name"
OSS_ENDPOINT="oss-cn-hangzhou.aliyuncs.com"

# 使用 aliyun CLI 上传
aliyun oss cp dist/ oss://$BUCKET_NAME/frontend/ -r -f --update

# 刷新 CDN
echo "Refreshing CDN..."
aliyun cdn RefreshObjectCaches --ObjectPath "http://$BUCKET_NAME.$OSS_ENDPOINT/frontend/*"

echo "Deploy complete!"
```

**Step 2: 构建测试**

```bash
cd frontend
npm run build
```

**Step 3: 提交**

```bash
git add frontend/deploy.sh
git commit -m "feat(m4): add deployment script"
```

---

## 完成标准

- [ ] 项目初始化完成，可以正常开发
- [ ] 设备列表页显示所有设备
- [ ] 实时预览页可以显示视频流
- [ ] 历史照片页可以加载和显示图片
- [ ] 设置页可以配置通知
- [ ] 前端可以构建成功

---

## 下一步

M4 完成后，进入 M5: 完善优化实施计划
